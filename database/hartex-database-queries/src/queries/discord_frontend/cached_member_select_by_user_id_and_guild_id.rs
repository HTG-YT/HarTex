// ==================! DO NOT MODIFY !==================
// This file is automatically generated by `hartex-database-typedsql`. Please do not modify this in
// any way.
// ==================! DO NOT MODIFY !==================

use std::env;
use tokio::net::TcpStream;
use wtx::database::Executor as _;
use wtx::database::client::postgres::Executor;
use wtx::database::client::postgres::ExecutorBuffer;
use wtx::misc::Uri;
use crate::result::IntoCrateResult;
pub struct CachedMemberSelectByUserIdAndGuildId {
    db_executor: Option<Executor<wtx::Error, ExecutorBuffer, TcpStream>>,
    executor_constructor: for<'a> fn(Uri<&'a str>) -> crate::internal::Ret<'a>,
    user_id: String,
    guild_id: String,
}
impl CachedMemberSelectByUserIdAndGuildId {
    #[must_use = "Queries must be executed after construction"]
    pub fn bind(user_id: String, guild_id: String) -> Self {
        Self {
            db_executor: None,
            executor_constructor: crate::internal::__internal_executor_constructor
                as for<'a> fn(Uri<&'a str>) -> crate::internal::Ret<'a>,
            user_id,
            guild_id,
        }
    }
    #[must_use = "A query must be executed after executor is created"]
    pub async fn executor(mut self) -> crate::result::Result<Self> {
        self.db_executor
            .replace(
                (self
                    .executor_constructor)(
                        Uri::new(&env::var("DISCORD_FRONTEND_PGSQL_URL").unwrap()),
                    )
                    .await?,
            );
        Ok(self)
    }
    #[must_use = "Query result(s) must be used"]
    pub async fn one(
        self,
    ) -> crate::result::Result<crate::tables::discord_frontend::NightlyCachedMembers> {
        self.db_executor
            .ok_or(
                crate::result::Error::Generic(
                    ".executor() has not been called on this query yet",
                ),
            )?
            .fetch_with_stmt(
                "SELECT * FROM \"DiscordFrontend\".\"Nightly\".\"CachedMembers\" WHERE user_id = $1 AND guild_id = $2",
                (self.user_id, self.guild_id),
            )
            .await
            .into_crate_result()
            .map(|record| crate::tables::discord_frontend::NightlyCachedMembers::try_from(
                record,
            ))
            .flatten()
    }
    #[must_use = "Query result(s) must be used"]
    pub async fn many(
        self,
    ) -> crate::result::Result<
        Vec<crate::tables::discord_frontend::NightlyCachedMembers>,
    > {
        use itertools::Itertools;
        use wtx::database::Records;
        self.db_executor
            .ok_or(
                crate::result::Error::Generic(
                    ".executor() has not been called on this query yet",
                ),
            )?
            .fetch_many_with_stmt(
                "SELECT * FROM \"DiscordFrontend\".\"Nightly\".\"CachedMembers\" WHERE user_id = $1 AND guild_id = $2",
                (self.user_id, self.guild_id),
                |_| Ok::<_, wtx::Error>(()),
            )
            .await
            .into_crate_result()?
            .iter()
            .map(|record| crate::tables::discord_frontend::NightlyCachedMembers::try_from(
                record,
            ))
            .process_results(|iter| iter.collect_vec())
    }
}
